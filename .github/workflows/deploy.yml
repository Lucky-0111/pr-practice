name: EC2 Deploy ì›Œí¬í”Œë¡œìš°

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'ë°°í¬í•  Docker ì´ë¯¸ì§€ íƒœê·¸'
        required: true
        type: string
      branch:
        description: 'ë¸Œëœì¹˜ëª…'
        required: true
        type: string
      commit_sha:
        description: 'ì»¤ë°‹ SHA'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: ğŸš€ EC2 ì„œë²„ì— ë°°í¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ EC2 ë°°í¬ ì‹œì‘
      id: deploy
      run: |
        # SSH í‚¤ íŒŒì¼ ìƒì„±
        echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
        chmod 600 private_key.pem
        
        # SSH ì˜µì…˜ ì„¤ì •
        export SSH_OPTIONS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        
        # EC2 ì„œë²„ì—ì„œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        ssh $SSH_OPTIONS -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e  # ì—ëŸ¬ ë°œìƒì‹œ ì¦‰ì‹œ ì¢…ë£Œ
          
          echo "ğŸš€ ë°°í¬ ì‹œì‘í•©ë‹ˆë‹¤..."
          
          # Docker ë¡œê·¸ì¸
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ (ì—ëŸ¬ ë¬´ì‹œ)
          echo "ğŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
          docker stop spring-app || true
          docker rm spring-app || true
          
          # ìƒˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
          echo "ğŸ“¥ ìƒˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ: ${{ inputs.image_tag }}"
          docker pull ${{ inputs.image_tag }}
          
          # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘
          echo "ğŸƒ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
          docker run -d \
            --name spring-app \
            --restart unless-stopped \
            -p 8080:8080 \
            -e SPRING_PROFILES_ACTIVE=prod \
            ${{ inputs.image_tag }}
          
          # Health Check ìˆ˜í–‰ (ìµœëŒ€ 60ì´ˆ)
          echo "ğŸ¥ ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ í™•ì¸ ì¤‘..."
          for i in {1..12}; do
            if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
              echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"
              break
            fi
            if [ $i -eq 12 ]; then
              echo "âŒ 60ì´ˆ í›„ì—ë„ Health Check ì‹¤íŒ¨"
              exit 1
            fi
            echo "â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘... ($i/12)"
            sleep 5
          done
          
          # ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬ (ìµœì‹  3ê°œ ì œì™¸)
          echo "ğŸ§¹ ì˜¤ë˜ëœ Docker ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
          docker images ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} --format "table {{.Repository}}:{{.Tag}}\t{{.CreatedAt}}" | tail -n +2 | sort -k2 -r | tail -n +4 | awk '{print $1}' | xargs -r docker rmi || true
          
          echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        EOF
        
        # SSH í‚¤ íŒŒì¼ ì‚­ì œ
        rm -f private_key.pem
        
        echo "deploy_result=success" >> $GITHUB_OUTPUT
      continue-on-error: true
      
    - name: âŒ ë°°í¬ ì‹¤íŒ¨ ìƒíƒœ ì„¤ì •
      if: failure()
      run: |
        echo "deploy_result=failure" >> $GITHUB_OUTPUT
        rm -f private_key.pem
        
    - name: ğŸ“‹ ë°°í¬ ì‹¤íŒ¨ ë¡œê·¸ ìˆ˜ì§‘
      if: failure()
      run: |
        echo "DEPLOY_LOGS<<EOF" >> $GITHUB_ENV
        echo "ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. EC2 ì¸ìŠ¤í„´ìŠ¤ì™€ Docker ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." >> $GITHUB_ENV
        echo "" >> $GITHUB_ENV
        echo "ì¼ë°˜ì ì¸ ë¬¸ì œ í•´ê²° ë°©ë²•:" >> $GITHUB_ENV
        echo "1. EC2 ì¸ìŠ¤í„´ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸" >> $GITHUB_ENV
        echo "2. SSH ì—°ê²°ì´ ê°€ëŠ¥í•œì§€ í™•ì¸" >> $GITHUB_ENV
        echo "3. Docker ë°ëª¬ ìƒíƒœ í™•ì¸" >> $GITHUB_ENV
        echo "4. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ í™•ì¸: docker logs spring-app" >> $GITHUB_ENV
        echo "5. í¬íŠ¸ 8080ì´ ì‚¬ìš© ê°€ëŠ¥í•œì§€ í™•ì¸" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        
    - name: ğŸ“¨ n8n ì›¹í›…ìœ¼ë¡œ ë°°í¬ ê²°ê³¼ ì „ì†¡
      if: always()
      run: |
        DEPLOY_STATUS="${{ steps.deploy.outputs.deploy_result || 'failure' }}"
        WEBHOOK_URL="${{ secrets.N8N_WEBHOOK_URL_DEPLOY }}"
        
        if [ "$DEPLOY_STATUS" = "success" ]; then
          MESSAGE="ğŸš€ EC2 ë°°í¬ ì™„ë£Œ! ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤ âœ¨"
          DETAILS="ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ê³  Health Checkë„ í†µê³¼í–ˆìŠµë‹ˆë‹¤"
        else
          MESSAGE="ğŸ’¥ EC2 ë°°í¬ ì‹¤íŒ¨! ë¬¸ì œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš” ğŸ˜°"
          DETAILS="${{ env.DEPLOY_LOGS || 'ë°°í¬ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }}"
        fi
        
        curl -X POST "$WEBHOOK_URL" \
          -H "Content-Type: application/json" \
          -d "{
            \"status\": \"$DEPLOY_STATUS\",
            \"message\": \"$MESSAGE\",
            \"branch\": \"${{ inputs.branch }}\",
            \"image_tag\": \"${{ inputs.image_tag }}\",
            \"commit_sha\": \"${{ inputs.commit_sha }}\",
            \"details\": \"$DETAILS\",
            \"repository\": \"${{ github.repository }}\",
            \"workflow_name\": \"EC2 Deploy ì›Œí¬í”Œë¡œìš°\",
            \"workflow_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
          }"
