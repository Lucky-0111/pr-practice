name: ğŸš€ Main CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # PRì— ëŒ€í•´ì„œë§Œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test-on-pr:
    name: ğŸ“‹ PR í…ŒìŠ¤íŠ¸ ë‹¨ê³„
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/test.yml
    secrets: inherit

  # Pushì— ëŒ€í•´ì„œë§Œ ë¹Œë“œ ë° ë°°í¬ ì‹¤í–‰
  build-and-deploy:
    name: ë¹Œë“œ & ë°°í¬ ë‹¨ê³„
    if: github.event_name == 'push'
    uses: ./.github/workflows/build.yml
    secrets: inherit

  # ì›Œí¬í”Œë¡œìš° ì™„ë£Œ ì•Œë¦¼
  notify-completion:
    name: íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ì•Œë¦¼
    if: always() && github.event_name == 'push'
    needs: [ build-and-deploy ]
    runs-on: ubuntu-latest
    
    steps:
      - name: Pipeline ì™„ë£Œ ì•Œë¦¼ ì „ì†¡
        run: |
          WEBHOOK_URL="${{ secrets.N8N_WEBHOOK_URL_PIPELINE }}"
          
          if [ "${{ needs.build-and-deploy.result }}" = "success" ]; then
            STATUS="success"
            MESSAGE="ğŸ‰ CI/CD Pipelineì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            DETAILS="${{ github.ref_name }} ë¸Œëœì¹˜ì˜ ëª¨ë“  ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤"
          else
            STATUS="failure" 
            MESSAGE="ğŸ’¥ CI/CD Pipelineì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            DETAILS="${{ github.ref_name }} ë¸Œëœì¹˜ì˜ íŒŒì´í”„ë¼ì¸ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê°œë³„ ì‘ì—… ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
          fi
          
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"status\": \"$STATUS\",
              \"message\": \"$MESSAGE\",
              \"branch\": \"${{ github.ref_name }}\",
              \"commit_sha\": \"${{ github.sha }}\",
              \"details\": \"$DETAILS\",
              \"repository\": \"${{ github.repository }}\",
              \"workflow_name\": \"Main CI/CD Pipeline\",
              \"workflow_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
            }" || echo "ì•Œë¦¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤"
